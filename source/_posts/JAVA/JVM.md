---
title: gc
date: 2022-12-20 17:26:18
categories:
  - JAVA
tags:
  - JVM
author: Fanrencli
---

## JVM相关知识

### 类的加载


1. 加载

    类的加载阶段主要是从文件系统或者网络中加载Class文件，class文件在文件开头有magic标识。在类的加载阶段只关注是否class文件的加载，对加载到的class文件是合法并不校验。其中类加载器主要分类两类：
    - 启动类加载器（Bootstrap Classloader）
        主要用于加载java核心类（String、Class)等一些sun包下的类和javax包下的。
    - 自定义加载器（继承了ClassLoad的加载器）
        扩展类加载器和应用加载器都是自定义加载器

    此外，启动类加载器和扩展类加载器以及应用加载器是符合双亲委派机制，但是他们不是继承关系，只是在加载类的过程中存在向上寻找的过程。因此，如果用户自定义加载器时，也可以通过实现findclass()方法实现双亲委派的过程。双亲委派机制的优势
    - 避免类的重复加载
    - 防止核心Api被篡改


2. 链接
    - 验证

        验证阶段主要用于对加载得到的文件内容进行校验，是否符合jVM的规范。主要为文件格式验证，元数据验证，字节码验证，符号引用验证
    - 准备

        在这个步骤为类变量（Static）分配内存并设置初始的默认值,注意这里不包含Final的变量，这类变量在编译的时候就进行了分配，实例变量也会分配内存，但是是在堆中分配
    - 解析

        主要将符号引用转为直接引用


3. 初始化阶段
    - 执行类构造器方法<clinit>，不是类的构造器。这个方法是这个类中所有类变量赋值动作和静态代码块的集合，

### 虚拟机栈

虚拟机栈为每个线程私有，不同的线程都有自己的虚拟机栈，栈中主要以栈帧为单位存放数据，每一个栈帧对应一个方法。栈帧中主要存放局部变量表、操作数栈、动态链接、方法返回地址、一些附加的信息。
当一个方法调用另一个方法则会在栈中入栈一个栈帧，返回一个方法则销毁一个栈帧。

- 局部变量表：这是垃圾收集判断是否对象已经死亡的主要地方。方法中所有的局部变量都存放在这里，可以存储局部变量的数据
- 操作数栈：主要是通过一个数组进行实现，通过push和pop对数据进行入栈和出栈。作为运算过程中的临时存储空间。
- 动态链接：动态链接就是符号引用，通过符号引用可以定位运行时常量池中的方法，从而在替换为直接引用
- 方法的返回地址：方法的返回地址主要用于将返回参数压入下一个方法的栈中，存放的是程序计数器的数据，用于确定下一个运行的指令地址。

### 对象

对象包含：
- 对象头：分为Mark word（8字节）和类元信息（8字节）
- 实例数据：类的成员变量
- 对齐填充：补齐为8字节的倍数
其中mark word包含对象的hashcode，分代年龄，是否偏向锁，锁标志位，偏向锁的线程